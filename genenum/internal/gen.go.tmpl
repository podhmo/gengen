{{- /* need: struct {Name string; Packages []string; Schemas []struct{ Prefix string; Name string; }; } */ -}}
//go:buld gen

// Code generated by gen.go.tmpl DO NOT EDIT.
package main

import (
	"encoding/json"
	"fmt"
	"log"

	"github.com/podhmo/gengen/genenum/generator"
	"github.com/podhmo/gengen/genenum/schema"
{{- range .Packages }}
	{{ . | printf "%q" }}
{{ end }}
)

func run() error {
	g, err := generator.NewGenerator()
	if err != nil {
		return fmt.Errorf("new generator: %w", err)
	}

	// pkg name
	pkg := {{ .Name | printf "%q" }}
	// input:
	schemas := []schema.Interface{
{{- range .Schemas }}
		{{ .Prefix }}.{{ .Name }}{},
{{ end }}
	}

	targets := make([]generator.Enum, len(schemas))

	for i, x := range schemas {
		typename := x.EnumName(x)

		b, err := schema.MarshalSchema(x)
		if err != nil {
			return fmt.Errorf("marshal in %v: %w", typename, err)
		}
		dst, err := generator.UnmarshalSchema(b)
		if err != nil {
			return fmt.Errorf("unmarshal in %v: %w", typename, err)
		}

		targets[i] = dst
	}

	b, err := g.Emit(pkg, targets)
	if err != nil {
		return fmt.Errorf("emit: %w", err)
	}
	fmt.Println(string(b))
	return nil
}

func main() {
	if err := run(); err != nil {
		log.Fatalf("!! %+v", err)
	}
}
